<script>

function substr_replace (str, replace, start, length) {
  // http://kevin.vanzonneveld.net
  if (start < 0) { // start position in str
    start = start + str.length;
  }
  length = length !== undefined ? length : str.length;
  if (length < 0) {
    length = length + str.length - start;
  }
  return str.slice(0, start) + replace.substr(0, length) + replace.slice(length) + str.slice(start + length);
}

//function highlight(needle, haystack){ 
//    var ind = haystack.indexOf(needle);
//    var len = needle.length; 
//    if(ind !== -1){ 
//        return substr($haystack, 0, $ind) . "<span class='highlight'>" . substr($haystack, $ind, $len) . "</span>" . 
//            $this->highlight($needle, substr($haystack, $ind + $len)); 
//    } else return $haystack; 
//} 

function excerpt(text, phrase,radius) {
        var ending = '...';
        var phraseLen = phrase.length;
        if (radius < phraseLen) {
            radius = phraseLen;
        }

        //$pos = strpos(strtolower($text), strtolower($phrase));
        var pos = text.indexOf(phrase);

        var startPos = 0;
        if (pos > radius) {
            startPos = pos - radius;
        }

        textLen = text.length;

        var endPos = pos + phraseLen + radius;
        if (endPos >= textLen) {
            endPos = textLen;
        }

        //$excerpt = substr($text, $startPos, $endPos - $startPos);
        var endr = endPos - startPos;
        var excerpt = text.substring(startPos,endr);
        if (startPos != 0) {
            excerpt = substr_replace(excerpt, ending, 0, phraseLen);
        }

        if (endPos != textLen) {
            excerpt = substr_replace(excerpt, ending, -phraseLen);
        }

        //return $this->highlight($phrase, $excerpt);
        return excerpt;
    }

var string = 'It\'s and really good question and interesting as it appears like that could be a common use case, and yet it is outside the scope of History.js - I\'m thinking I will include a new file called history.extra.js - which includes some common utility functions.';
var word = 'Appears';
console.log(excerpt(string,word,100));
</script>
